<!DOCTYPE html>
<html lang="fa" dir="rtl">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>اطلاعات مشتریان بانک سپه</title>
  <style>
    body {
      font-family: Tahoma, Arial, sans-serif;
      direction: rtl;
      margin: 20px;
      background-color: #f5f5f5;
    }
    
    h1 {
      text-align: center;
    }
    
    .container {
      max-width: 1000px;
      margin: 0 auto;
      background-color: white;
      padding: 20px;
    }
    
    .search-box {
      margin-bottom: 20px;
    }
    
    .search-box input {
      width: 100%;
      padding: 10px;
      font-family: Tahoma, Arial, sans-serif;
    }
    
    table {
      width: 100%;
      border-collapse: collapse;
    }
    
    th, td {
      padding: 8px;
      text-align: right;
      border: 1px solid #ddd;
    }
    
    th {
      background-color: #f2f2f2;
    }
    
    .loading {
      text-align: center;
      padding: 20px;
    }
    
    .error {
      color: red;
      text-align: center;
      padding: 10px;
    }
    
    .stats {
      margin-top: 10px;
      text-align: center;
      font-size: 0.9em;
      color: #666;
    }
  </style>
</head>
<body>
  <div class="container">
    <h1>اطلاعات مشتریان بانک سپه</h1>
    
    <div id="errorMessage" class="error" style="display: none;"></div>
    <div id="loading" class="loading">در حال بارگذاری اطلاعات...</div>
    
    <div class="search-box">
      <input type="text" id="searchInput" placeholder="جستجو (نام، کد ملی یا شماره موبایل)...">
    </div>
    
    <div id="stats" class="stats"></div>
    
    <table id="customerTable" style="display: none;">
      <thead>
        <tr>
          <th>نام مشتری</th>
          <th>کد ملی</th>
          <th>محل تولد</th>
          <th>شماره موبایل</th>
          <th>گروه مشتریان</th>
        </tr>
      </thead>
      <tbody id="tableBody">
        <!-- داده‌ها اینجا قرار می‌گیرند -->
      </tbody>
    </table>
  </div>

  <!-- کتابخانه SQL.js -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/sql.js/1.8.0/sql-wasm.js"></script>
  
  <script>
    // اجرای کد پس از بارگذاری صفحه
    document.addEventListener('DOMContentLoaded', function() {
      // تنظیم رویداد جستجو
      document.getElementById('searchInput').addEventListener('input', function() {
        const searchText = this.value.trim();
        if (searchText.length >= 2) {
          searchDatabase(searchText);
        } else if (searchText.length === 0) {
          clearResults();
        }
      });
      
      // بارگذاری دیتابیس
      initSqlJs();
    });
    
    // متغیرهای سراسری
    let db = null;
    let SQL = null;
    
    // راه‌اندازی SQL.js و بارگذاری دیتابیس
    async function initSqlJs() {
      try {
        // نمایش وضعیت بارگذاری
        document.getElementById('loading').style.display = 'block';
        document.getElementById('customerTable').style.display = 'none';
        document.getElementById('errorMessage').style.display = 'none';
        
        // راه‌اندازی SQL.js
        SQL = await initSqlJsLibrary();
        
        // بارگذاری فایل دیتابیس
        const dbResponse = await fetch('data/customers.db');
        if (!dbResponse.ok) {
          throw new Error(`خطا در بارگذاری دیتابیس: ${dbResponse.status} ${dbResponse.statusText}`);
        }
        
        const dbBuffer = await dbResponse.arrayBuffer();
        const uInt8Array = new Uint8Array(dbBuffer);
        
        // ایجاد دیتابیس
        db = new SQL.Database(uInt8Array);
        
        // نمایش آمار دیتابیس
        showDatabaseStats();
        
        // مخفی کردن وضعیت بارگذاری
        document.getElementById('loading').style.display = 'none';
        document.getElementById('customerTable').style.display = 'table';
        
        console.log('دیتابیس با موفقیت بارگذاری شد.');
      } catch (error) {
        console.error('خطا در راه‌اندازی دیتابیس:', error);
        
        // نمایش پیام خطا
        document.getElementById('loading').style.display = 'none';
        document.getElementById('errorMessage').style.display = 'block';
        document.getElementById('errorMessage').textContent = `خطا در بارگذاری دیتابیس: ${error.message}`;
      }
    }
    
    // راه‌اندازی کتابخانه SQL.js
    function initSqlJsLibrary() {
      return new Promise((resolve, reject) => {
        try {
          // تنظیم مسیر فایل‌های wasm
          const config = {
            locateFile: filename => `https://cdnjs.cloudflare.com/ajax/libs/sql.js/1.8.0/${filename}`
          };
          
          // راه‌اندازی SQL.js
          initSqlJs(config).then(resolve).catch(reject);
        } catch (error) {
          reject(error);
        }
      });
    }
    
    // نمایش آمار دیتابیس
    function showDatabaseStats() {
      if (!db) return;
      
      try {
        // دریافت تعداد کل رکوردها
        const totalCountResult = db.exec("SELECT COUNT(*) FROM customers");
        const totalCount = totalCountResult[0].values[0][0];
        
        // نمایش آمار
        const statsElement = document.getElementById('stats');
        statsElement.textContent = `تعداد کل رکوردها: ${totalCount.toLocaleString()} | برای جستجو، حداقل ۲ کاراکتر وارد کنید`;
      } catch (error) {
        console.error('خطا در نمایش آمار:', error);
      }
    }
    
    // جستجو در دیتابیس
    function searchDatabase(searchText) {
      if (!db) return;
      
      try {
        // اجرای کوئری جستجو
        const query = `
          SELECT name, national_id, birth_place, mobile, customer_group 
          FROM customers 
          WHERE name LIKE ? OR national_id LIKE ? OR mobile LIKE ? 
          LIMIT 500
        `;
        
        const searchPattern = `%${searchText}%`;
        const stmt = db.prepare(query);
        stmt.bind([searchPattern, searchPattern, searchPattern]);
        
        // جمع‌آوری نتایج
        const customers = [];
        while (stmt.step()) {
          const row = stmt.getAsObject();
          customers.push({
            name: row.name,
            national_id: row.national_id,
            birth_place: row.birth_place,
            mobile: row.mobile,
            customer_group: row.customer_group
          });
        }
        
        // آزادسازی منابع
        stmt.free();
        
        // نمایش نتایج
        displayData(customers);
        
        // به‌روزرسانی آمار جستجو
        const statsElement = document.getElementById('stats');
        statsElement.textContent = `نتایج جستجو برای "${searchText}": ${customers.length} رکورد یافت شد${customers.length >= 500 ? ' (حداکثر 500 مورد نمایش داده می‌شود)' : ''}`;
      } catch (error) {
        console.error('خطا در جستجو:', error);
        document.getElementById('errorMessage').style.display = 'block';
        document.getElementById('errorMessage').textContent = `خطا در جستجو: ${error.message}`;
      }
    }
    
    // پاک کردن نتایج
    function clearResults() {
      const tableBody = document.getElementById('tableBody');
      tableBody.innerHTML = '';
      
      // بازگرداندن آمار اصلی
      showDatabaseStats();
    }
    
    // نمایش داده‌ها در جدول
    function displayData(customers) {
      const tableBody = document.getElementById('tableBody');
      tableBody.innerHTML = '';
      
      if (customers.length === 0) {
        // نمایش پیام خالی بودن
        const emptyRow = document.createElement('tr');
        const emptyCell = document.createElement('td');
        emptyCell.colSpan = 5;
        emptyCell.textContent = 'هیچ نتیجه‌ای یافت نشد.';
        emptyCell.style.textAlign = 'center';
        emptyRow.appendChild(emptyCell);
        tableBody.appendChild(emptyRow);
        return;
      }
      
      // ایجاد فرگمنت برای بهبود عملکرد
      const fragment = document.createDocumentFragment();
      
      // نمایش داده‌ها
      customers.forEach(customer => {
        const row = document.createElement('tr');
        
        // نام مشتری
        const nameCell = document.createElement('td');
        nameCell.textContent = customer.name;
        row.appendChild(nameCell);
        
        // کد ملی
        const nationalIdCell = document.createElement('td');
        nationalIdCell.textContent = customer.national_id;
        row.appendChild(nationalIdCell);
        
        // محل تولد
        const birthPlaceCell = document.createElement('td');
        birthPlaceCell.textContent = customer.birth_place;
        row.appendChild(birthPlaceCell);
        
        // شماره موبایل
        const mobileCell = document.createElement('td');
        mobileCell.textContent = customer.mobile;
        row.appendChild(mobileCell);
        
        // گروه مشتریان
        const customerGroupCell = document.createElement('td');
        customerGroupCell.textContent = customer.customer_group;
        row.appendChild(customerGroupCell);
        
        fragment.appendChild(row);
      });
      
      // افزودن به جدول
      tableBody.appendChild(fragment);
    }
  </script>
</body>
</html>
